var QLupaSegAdv_dialogolupa=null,QLupaSegAdv_grillaLupa=null,QLupaSegAdv_Segmento=null,QLupaSegAdv_Identidad=null,QLupaSegAdv_TiposControlesRet=null,QLupaSegAdv_FiltrosOcultos="",QLupaSegAdv_Extras=null,QLupaSegAdv_CantRegPorPagina=50,QLupaSegAdv_CantRegistrosTotal=0,QLupaSegAdv_MaximaCantPermitida=20,QLupaSegAdv_Inicializada= false,QLupaSegAdv_GrillaCreada= false,QLupaSegAdv_FuncionCliente=null,QLupaSegAdv_CamposSegmento=null,QLupaSegAdv_CamposSegmentoenFE=null,QLupaSegAdv_CamposAliasSegmento=null,QLupaSegAdv_CamposRet=
null,QLupaSegAdv_ObjetoSegmento=null,QLupaSegAdv_TablaFE="",QLupaSegAdv_EsEntidadDelForm= false,QLupaSegAdv_CamposVisibles=null,QLupaSegAdv_NombreCtrl=null,QLupaSegAdv_PrimColVisible=-1,QLupaSegAdv_Estructura=null,QLupaSegAdv_Formulario="",QLupaSegAdv_TituloForm="",QLupaSegAdv_PrimEditor=null,QLupaSegAdv_SelXTecladoProcesado= false,QLupaSegAdv_AnchoTotal=0,QLupaSegAdv_PrimeraVez= true,QLupaSegAdv_FnAccion="";
function QLupaSegAdv_MostrarLupa(a,m,k,h,e,n,t,d,f,b,p,r,c,l,g){QLupaSegAdv_SelXTecladoProcesado= false;QLupaSegAdv_TiposControlesRet=e;QLupaSegAdv_FiltrosOcultos=qcom_ObtenerValorParametrosFiltro(b);QLupaSegAdv_Extras=p;QLupaSegAdv_FuncionCliente=f;QLupaSegAdv_Segmento=m;QLupaSegAdv_CamposSegmento=t;QLupaSegAdv_CamposAliasSegmento=d;QLupaSegAdv_TablaFE=h;QLupaSegAdv_CamposSegmentoenFE=n;QLupaSegAdv_EsEntidadDelForm=r;QLupaSegAdv_Formulario=c;QLupaSegAdv_TituloForm=l;QLupaSegAdv_FnAccion=g;lMismaIdentidad=
a==QLupaSegAdv_NombreCtrl;QLupaSegAdv_NombreCtrl=a;QLupaSegAdv_Identidad=k;QLupaSegAdv_Inicializada||QLupaSegAdv_Inicializar();QLupaSegAdv_ObtenerConfiguracion(a,m,k);qpopup_ZIndexAsignar(QLupaSegAdv_dialogolupa)}function QLupaSegAdv_Inicializar(){$("#divGrillaLupaSeg").append("<table id='gridlupaseg'></table>");QLupaSegAdv_grillaLupa=$("#gridlupaseg");QLupaSegAdv_dialogolupa=$("#divModalLupaSeg");$("#tituloModalLupaSeg").text(QLupaSegAdv_TituloForm);QLupaSegAdv_Inicializada= true}
var fTeclasEspecialesSeg=function(a){if(40==a.keyCode)$("#gridlupaseg").igGridSelection("selectRow",0),$("#gridlupaseg_container").attr("tabIndex",0);else if(";"==a.key)return false};
function QLupaSegAdv_SeleccionarRegistro(a){QLupaSegAdv_EsEntidadDelForm?(gTieneSinGuardar= false,qcom_InicSolapasActivadas( false)):gTieneSinGuardar= true;if(null!=QLupaSegAdv_TiposControlesRet){for(var m=QLupaSegAdv_TiposControlesRet.length,k=0;k<m;k++){var h=QLupaSegAdv_grillaLupa.igGrid("getCellValue",a,QLupaSegAdv_CamposRet[k]);"mes"==QLupaSegAdv_TiposControlesRet[k].toLowerCase()&&(h=("0"+h).slice(-2));qcom_AsignarValorControl(gControles[QLupaSegAdv_TablaFE][0][QLupaSegAdv_CamposSegmentoenFE[k]],h, false);
if(null!=gControles[QLupaSegAdv_TablaFE][0][QLupaSegAdv_CamposSegmentoenFE[k]])for(var e=1;8>=e;e++)QLupaSegAdv_ObjetoSegmento.getCampoNCCtrlSeg(e)==QLupaSegAdv_CamposSegmentoenFE[k]&&""!=QLupaSegAdv_ObjetoSegmento.getCampoNCCtrl(e)&&qcom_AsignarValorControl(gControles[QLupaSegAdv_TablaFE][0][QLupaSegAdv_ObjetoSegmento.getCampoNCCtrl(e)],h, false)}QLupaSegAdv_CamposOcultos=QLupaSegAdv_TiposControlesRet=null;$("#divModalLupaSeg").attr("Abierto","false");QLupaSegAdv_dialogolupa.modal("hide");a=0;""!=QLupaSegAdv_FnAccion&&
(m=gEventosTmp.length,qevt_AgregarEventoaTmp(QLupaSegAdv_FnAccion,null, false),m<gEventosTmp.length&&a++);0<a&&gEventosTmp.length==a&&qevt_EjecutarSiguiente()}}
function QLupaSegAdv_CrearGrilla(a,m){$("#divCargando").addClass("show");QLupaSegAdv_grillaLupa.hide();QLupaSegAdv_GrillaCreada= true;var k=sessionStorage.getItem("idses"),h=[],e=[],n=[],t=[],d=100,f=100;768>$(document).width()&&(d=5,lAnchoDef=300,f=50);for(var b=1;8>=b;b++)""!=QLupaSegAdv_ObjetoSegmento.getCampoNCCtrlSeg(b)&&n.push(QLupaSegAdv_ObjetoSegmento.getCampoSegAlias(b));for(var p=n.length,b=0;b<QLupaSegAdv_CamposVisibles.length&&b+p<d;b++)n.push(QLupaSegAdv_CamposVisibles[b].Campo);h.push({headerText:"N",
key:"N",dataType:"number",hidden: true});e.push({columnKey:"N",editorType:"numeric",allowFiltering: false});QLupaSegAdv_AnchoTotal=0;6>n.length&&(f=600/n.length);for(b=0;b<QLupaSegAdv_Estructura.length;b++){var d=QLupaSegAdv_Estructura[b].Campo,p=QLupaSegAdv_Estructura[b].NombreCampo,r=""==QLupaSegAdv_Estructura[b].CondicionInicial?null:QLupaSegAdv_Estructura[b].CondicionInicial,c=0==QLupaSegAdv_Estructura[b].Longitud?f:8*QLupaSegAdv_Estructura[b].Longitud,l=8*d.length+8,g=-1>=jQuery.inArray(d,n);t.push({columnKey:d,
allowResizing: true});switch(QLupaSegAdv_Estructura[b].TipoCampo){case "I":c=50>c+30?50:c+30;c=l>c?l:c;h.push({headerText:p,key:d,dataType:"number",columnCssClass:"alignCol-derecha",headerCssClass:"alignHeaderCol-derecha",width:c,hidden:g,format:"0"});e.push({columnKey:d,editorType:"numeric",allowFiltering:!g,condition:r,editorOptions:{buttonType:"none",dataMode:"int",spinDelta:0,allowNullValue: true}});break;case "N":c=58>c+34?58:c+34;c=l>c?l:c;h.push({headerText:p,key:d,dataType:"number",columnCssClass:"alignCol-derecha",
headerCssClass:"alignHeaderCol-derecha",width:c,hidden:g,format:"0.0000"});e.push({columnKey:d,editorType:"numeric",allowFiltering:!g,condition:r,editorOptions:{buttonType:"none",dataMode:"decimal",spinDelta:0,maxDecimals:2,minDecimals:0,allowNullValue: true}});break;case "F":c=140<l?l:140;h.push({headerText:p,key:d,dataType:"date",columnCssClass:"alignCol-izquierda",headerCssClass:"alignHeaderCol-izquierda",width:c,hidden:g,format:"dd-MM-yyyy"});e.push({columnKey:d,editorType:"date",allowFiltering:!g,
editorOptions:{dataMode:"date",spinDelta:0,allowNullValue: true}});break;case "B":c=35<l?l:35;h.push({headerText:p,key:d,dataType:"bool",width:c,hidden:g});e.push({columnKey:d,allowFiltering:!g});break;default:c=80>c+44?80:c+44,c=l>c?l:c,h.push({headerText:p,key:d,dataType:"string",columnCssClass:"alignCol-izquierda",headerCssClass:"alignHeaderCol-izquierda",width:c,hidden:g}),e.push({columnKey:d,editorType:"text",condition:r,allowFiltering:!g})}g||(QLupaSegAdv_AnchoTotal+=c)}QLupaSegAdv_grillaLupa.igGrid({autoGenerateColumns: false,
renderCheckboxes: true,width:"100%",responseDataKey:"data",dataSource:"AjaxHandler/QLupaSegAdvDatos.ashx?AbroLupa=S&Segmento="+a+"&Identidad="+m+"&CamposSegmento="+QLupaSegAdv_CamposSegmento.join("|")+"&CamposAliasSegmento="+QLupaSegAdv_CamposAliasSegmento+"&filtroSP="+QLupaSegAdv_FiltrosOcultos+"&IndicePagina=0&TamaioPagina="+QLupaSegAdv_CantRegPorPagina+"&Idses="+k,columns:h,features:[{name:"Filtering",type:"remote",mode:"simple",filterExprUrlKey:"filtro",columnSettings:e},{name:"Selection",mode:"row",
activation: true},{name:"RowSelectors",enableRowNumbering: false,rowSelectorColumnWidth:5},{name:"Paging",type:"remote",pageSize:QLupaSegAdv_CantRegPorPagina,recordCountKey:"recordCountKey",pageIndexUrlKey:"pageIndex",pageSizeUrlKey:"pageSize"},{name:"Resizing",deferredResizing: false,allowDoubleClickToResize: true,columnSettings:t},{name:"Sorting",type:"remote",sortUrlKey:"sortKey",mode:"single",columnSorting:function(c,a){$("#gridlupaseg").igGridPaging("pageIndex",0)}}],rendered:function(c,a){gridColumns=QLupaSegAdv_grillaLupa.igGrid("option",
"columns");gridColumns.length&&(QLupaSegAdv_PrimEditor=$("#gridlupaseg_container [id$='EditingInput'].ui-iggrid-filtereditor")[0].id);if(null!=QLupaSegAdv_PrimEditor){for(var d=$("#gridlupaseg_container [id$='EditingInput'].ui-iggrid-filtereditor").length,b=0;b<d;b++)$("#gridlupaseg_container [id$='EditingInput'].ui-iggrid-filtereditor")[b].onkeydown=fTeclasEspecialesSeg;$("#gridlupaseg").on("keydown","tr",function(c,a){if(13==c.keyCode&&!QLupaSegAdv_SelXTecladoProcesado){var b=$("#gridlupaseg").igGrid("activeRow");
null!=b&&(QLupaSegAdv_SelXTecladoProcesado= true,c.stopPropagation(),c.preventDefault(),QLupaSegAdv_SeleccionarRegistro(b.index))}})}$("#divCargando").removeClass("show");setTimeout(function(){var c=.9*$(window).height();$("#divGrillaLupaSeg").height(c-47);$("#gridlupaseg").igGrid("option","height",c);$("#divModalLupaSegDlg").width(QLupaSegAdv_AnchoTotal+15);QLupaSegAdv_grillaLupa.show();QLupaSegAdv_dialogolupa.modal({keyboard: true,tabindex:-1,backdrop:"static",show: true});QLupaSegAdv_PrimeraVez&&(QLupaSegAdv_PrimeraVez=
 false,QLupaSegAdv_dialogolupa.on("shown.bs.modal",function(){null!=QLupaSegAdv_PrimEditor&&$("#"+QLupaSegAdv_PrimEditor).focus()}));QLupaSegAdv_dialogolupa.draggable({handle:".modal-header"});QLupaSegAdv_dialogolupa.unbind("dragstop");QLupaSegAdv_dialogolupa.on("dragstop",function(c,b){var a=void 0!==window.pageYOffset?window.pageYOffset:window.scrollTop;0>b.helper[0].offsetTop?0<a?QLupaSegAdv_dialogolupa.offset({top:a,left:b.helper[0].offsetLeft}):QLupaSegAdv_dialogolupa.offset({top:0,left:b.helper[0].offsetLeft}):
0<a&&QLupaSegAdv_dialogolupa.offset({top:a,left:b.helper[0].offsetLeft})})},10)},dataBound:function(c,b){if(!b.dataSource._hasCount){$("#divCargando").removeClass("show");var a=JSON.parse(b.dataSource._ajaxRequest.responseText);void 0!=a.e&&qcom_TratarError(a.e)}},schemaGenerated:function(c,b){},cellClick:function(c,b){QLupaSegAdv_SeleccionarRegistro(b.rowIndex)},cellRightClick:function(b,c){if(""!=QLupaSegAdv_Formulario){QLupaSegAdv_grillaLupa.igGridSelection("selectRow",c.rowIndex);b.stopPropagation();
b.preventDefault();var a=$("#gridlupaseg").igGridSelection("selectedRow");if(null!=a){event.stopPropagation();event.preventDefault();var d="",n="";if(null!=QLupaSegAdv_TiposControlesRet)for(var e=QLupaSegAdv_TiposControlesRet.length,f=0;f<e;f++){var g=QLupaSegAdv_grillaLupa.igGrid("getCellValue",a.index,QLupaSegAdv_CamposRet[f]);"mes"==QLupaSegAdv_TiposControlesRet[f].toLowerCase()&&(g=("0"+g).slice(-2));d+=n+g;n="-"}qpopup_MostrarForm(QLupaSegAdv_Formulario,d,"","",QLupaSegAdv_TituloForm, true)}}}})}
function QLupaSegAdv_ObtenerConfiguracion(a,m,k){QLupaSegAdv_CamposRet=null;QLupaSegAdv_CamposRet=QLupaSegAdv_CamposAliasSegmento.split("|");for(var h=gSegmentos.length,e=0;e<h;e++)gSegmentos[e].getNombre()==a&&(QLupaSegAdv_ObjetoSegmento=gSegmentos[e]);$("#divCargando").addClass("show");a=sessionStorage.getItem("idses");$.ajax({type:"POST",url:"AjaxHandler/QLupaSegAdvConf.ashx",data:{Segmento:m,Identidad:k,IdSes:a},dataType:"json"}).done(function(a){if(null!=a.e)$("#divCargando").removeClass("show"),
null!=a.m?qcom_TratarError(a.e+"|"+a.m):qcom_TratarError(a.e);else{$("#divCargando").removeClass("show");QLupaSegAdv_CamposVisibles=a.CamposVisibles;QLupaSegAdv_Estructura=a.Campos;for(a=QLupaSegAdv_ObjetoSegmento.getPosiciones().length-1;0<=a;a--)for(var e=QLupaSegAdv_ObjetoSegmento.getPosiciones()[a],d= false,f=1;8>=f&&!d;f++)if(QLupaSegAdv_ObjetoSegmento.getCampoNCCtrlSeg(f)==e||QLupaSegAdv_ObjetoSegmento.getCampoNCCtrl(f)==e){var d= true,b=QLupaSegAdv_ObjetoSegmento.getCampoSegAlias(f),h=QLupaSegAdv_ObjetoSegmento.getCampoLongitud(f);
5>f?QLupaSegAdv_Estructura.unshift({Campo:b,NombreCampo:b,TipoCampo:"I",Longitud:h,CondicionInicial:""}):QLupaSegAdv_Estructura.unshift({Campo:b,NombreCampo:b,TipoCampo:"S",Longitud:h,CondicionInicial:""})}QLupaSegAdv_GrillaCreada&&QLupaSegAdv_grillaLupa.igGrid("destroy");QLupaSegAdv_CrearGrilla(m,k)}}).fail(function(a,e,d){$("#divCargando").removeClass("show");qcom_Alerta(d,"danger",null)})}
function QLupaSegAdv_MostrarLupaDesdeBtn(a,m,k,h,e,n,t){var d=qcom_ObtenerSegmento(m),f=[],b=[],p=[],r="",c=d.getPosiciones(),l="";if(a)for(a=0;a<c.length;a++){for(var g= false,q=1;8>=q&&!g;q++)d.getCampoNCCtrl(q)==c[a]&&(g= true,r+=l+d.getCampoSegAlias(q),5>q?f.push("Int"):f.push("String"));b.push(d.getCampoNCCtrlSeg(a+1));p.push(d.getCampoNCCtrlSeg(a+1));l="|"}else for(a=0;a<c.length;a++){g= false;for(q=1;8>=q&&!g;q++)d.getCampoNCCtrlSeg(q)==c[a]&&(g= true,r+=l+lSegmento.getCampoSegAlias(q),5>q?f.push("Int"):
f.push("String"));b.push(c[a]);p.push(c[a]);l="|"}QLupaSegAdv_MostrarLupa(m,lSegmento.getIdSeg(),k,lSegmento.getTabla(),f,b,p,r,null,h,"",e,n,t)};
